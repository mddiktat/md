<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dictation → Arztbrief (Gemini)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 980px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 12px 0; }
    button { padding: 10px 14px; border: 1px solid #ccc; background: #fff; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input[type="text"] { padding: 10px 12px; border: 1px solid #ccc; border-radius: 10px; width: 520px; }
    .status { padding: 10px 12px; border: 1px solid #e5e5e5; background: #fafafa; border-radius: 10px; }
    textarea { width: 100%; min-height: 320px; padding: 12px; border: 1px solid #ccc; border-radius: 12px;
               font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .small { color: #555; font-size: 12px; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #ddd; background: #fff; font-size: 12px; }
    .warn { border-color: #f2c200; background: #fff9db; }
    .ok { border-color: #2fb344; background: #ebfbee; }
    .err { border-color: #fa5252; background: #fff5f5; }
  </style>
</head>
<body>
  <h1>Medical Dictation → Arztbrief (Gemini backend)</h1>

  <div class="row">
    <span class="small">Backend URL:</span>
    <input id="backendUrl" type="text" />
    <span class="pill">POST /format</span>
  </div>

  <div class="row">
    <button id="btnStart">Start Dictation</button>
    <button id="btnStop" disabled>Stop</button>
    <span id="lang" class="pill">de-DE</span>
    <span id="support" class="pill">Speech: —</span>
  </div>

  <div id="status" class="status warn">
    Uses browser speech recognition (Chrome/Edge). Then formats via your Gemini backend.
  </div>

  <div class="row">
    <button id="btnFormat" disabled>Format to Brief</button>
    <button id="btnCopy" disabled>Copy brief</button>
    <button id="btnClear">Clear</button>
  </div>

  <div class="row">
    <div style="flex:1">
      <div class="small">Live transcript (editable)</div>
      <textarea id="transcript" placeholder="Your transcript will appear here..."></textarea>
    </div>
  </div>

  <div class="row">
    <div style="flex:1">
      <div class="small">Final brief</div>
      <textarea id="output" placeholder="Formatted brief appears here..."></textarea>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_BACKEND_BASE = "https://web-production-2ecad.up.railway.app";
  const REQUIRED_SECTIONS = ["Anamnese:", "Klinische Untersuchung:", "Bildgebung:", "Therapie:"];

  const backendUrlEl = document.getElementById("backendUrl");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnFormat = document.getElementById("btnFormat");
  const btnCopy = document.getElementById("btnCopy");
  const btnClear = document.getElementById("btnClear");
  const statusEl = document.getElementById("status");
  const transcriptEl = document.getElementById("transcript");
  const outputEl = document.getElementById("output");
  const supportEl = document.getElementById("support");

  backendUrlEl.value = DEFAULT_BACKEND_BASE;

  function setStatus(msg, kind="warn") {
    statusEl.className = `status ${kind}`;
    statusEl.innerHTML = msg;
  }

  function normalizeBaseUrl(raw) {
    let base = (raw || "").trim().replace(/\/+$/, "");
    if (!/^https?:\/\//i.test(base)) base = "https://" + base;
    return base;
  }

  function ensureAllSections(text) {
    let out = (text || "").trim();
    for (const s of REQUIRED_SECTIONS) {
      if (!out.includes(s)) out += `\n\n${s}\nnicht diktiert`;
    }
    return out.trim();
  }

  // --- Web Speech API setup ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    supportEl.textContent = "Speech: NOT supported";
    setStatus("Your browser does not support Web Speech API. Use Chrome/Edge.", "err");
    btnStart.disabled = true;
    return;
  }
  supportEl.textContent = "Speech: supported";

  const rec = new SpeechRecognition();
  rec.lang = "de-DE";
  rec.interimResults = true;
  rec.continuous = true;

  let listening = false;
  let finalText = "";

  rec.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const chunk = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalText += chunk + " ";
      else interim += chunk;
    }
    transcriptEl.value = (finalText + interim).trim();
    btnFormat.disabled = transcriptEl.value.trim().length === 0;
  };

  rec.onerror = (e) => {
    console.error(e);
    setStatus(`Speech error: <code>${e.error || "unknown"}</code>`, "err");
    listening = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
  };

  rec.onend = () => {
    listening = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    if (transcriptEl.value.trim()) btnFormat.disabled = false;
    setStatus("Dictation stopped.", "ok");
  };

  btnStart.addEventListener("click", () => {
    try {
      finalText = transcriptEl.value.trim() ? (transcriptEl.value.trim() + " ") : "";
      rec.start();
      listening = true;
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnFormat.disabled = true;
      setStatus("Listening… speak now. Click Stop when finished.", "warn");
    } catch (e) {
      console.error(e);
      setStatus(`Could not start speech recognition: <code>${e.message || e}</code>`, "err");
    }
  });

  btnStop.addEventListener("click", () => {
    if (!listening) return;
    setStatus("Stopping…", "warn");
    rec.stop();
  });

  btnFormat.addEventListener("click", async () => {
    const text = transcriptEl.value.trim();
    if (!text) return;

    setStatus("Formatting via backend…", "warn");
    btnFormat.disabled = true;
    btnCopy.disabled = true;

    try {
      const base = normalizeBaseUrl(backendUrlEl.value);
      const endpoint = `${base}/format`;

      const res = await fetch(endpoint, {
        method: "POST",
        mode: "cors",
        credentials: "omit",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.detail || `HTTP ${res.status} ${res.statusText}`);
      }

      const brief = ensureAllSections(String(data.text || ""));
      outputEl.value = brief;
      btnCopy.disabled = !brief;
      setStatus("Done. Brief is ready to copy.", "ok");
    } catch (e) {
      console.error(e);
      setStatus(`Format failed: <code>${e.message || e}</code>`, "err");
      btnFormat.disabled = false;
    }
  });

  btnCopy.addEventListener("click", async () => {
    const text = outputEl.value.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      setStatus("Copied to clipboard ✅", "ok");
    } catch {
      outputEl.focus();
      outputEl.select();
      document.execCommand("copy");
      setStatus("Copied (fallback) ✅", "ok");
    }
  });

  btnClear.addEventListener("click", () => {
    finalText = "";
    transcriptEl.value = "";
    outputEl.value = "";
    btnFormat.disabled = true;
    btnCopy.disabled = true;
    setStatus("Cleared.", "warn");
  });
})();
</script>
</body>
</html>
